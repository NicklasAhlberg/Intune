<#	
	.NOTES
	===========================================================================
	 Created on:   	2023-06-15
	 Created by:   	Nicklas Ahlberg
	 Organization: 	rockenroll.tech
	 Filename:     	Detection.ps1
	 Updated on:   	2023-06-15
	 Version:       1.0.0.1
	===========================================================================
	.DESCRIPTION
		Use this script as part of mitigating CVE-2023-32019
	.WARRANTY
		The script is provided "AS IS" with no warranties
#>

# https://support.microsoft.com/en-us/topic/kb5028407-how-to-manage-the-vulnerability-associated-with-cve-2023-32019-bd6ed35f-48b1-41f6-bd19-d2d97270f080

# Get OS version. Determine build and revision version
[version]$osversion = (get-computerinfo).osversion
$ubr = (get-computerinfo).windowsubr

[Version]$currentOSversion = "$osversion.$ubr"

function Check-Registry {
    param (
        [Parameter (Mandatory = $false)] [String]$regValue
    )
    $regHive = "HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides"


    # Create both reg key and value if the key doesn't exist
    if (!(Test-Path $regHive)) {
        Write-Output "Correct regvalue has not been set, running remediation."
        exit 1
    }

    else {
        if ((Get-Item -Path $regHive | Select-Object -ExpandProperty Property) -match $regValue) {
            Write-Output "Correct regvalue has already been set."
            exit 0
        }
        else {
            Write-Output "Correct regvalue has not been set, running remediation."
            exit 1        
        }  
    } 
}

# If Windows 11 22H2 (build 22621)
if ($currentOSversion.Build -eq '22621') {
    Write-Output "Running Windows 11-22H2"
    if ($currentOSversion.Revision -ge '1848') {
        Check-Registry -regValue "4237806220"
    }
}

# If Windows 11 21H2 (build 22000)
if ($currentOSversion.Build -eq '22000') {
    Write-Output "Running Windows 11-21H2"
    if ($currentOSversion.Revision -ge '2057') {
        Check-Registry -regValue "4204251788"
    }
}

# If Windows 10 20H2, 21H2, 22H2 (build 19042, 19044, 19045)
if ($currentOSversion.Build -eq '19042') {
    Write-Output "Running Windows 10-20H2"
    if ($currentOSversion.Revision -ge '2965') {
        Check-Registry -regValue "4103588492"
    }
}

if ($currentOSversion.Build -eq '19044') {
    Write-Output "Running Windows 10-21H2"
    if ($currentOSversion.Revision -ge '3086') {
        Check-Registry -regValue "4103588492"
    }
}

if ($currentOSversion.Build -eq '19045') {
    Write-Output "Running Windows 10-22H2"
    if ($currentOSversion.Revision -ge '3086') {
        Check-Registry -regValue "4103588492"
    }
}

else {
    Write-Output "Windows must be updated to atleast 2023-06 before applying this fix."
}